<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Potencial Business Pro v4.6 — MASTER UY (G3)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#070b14; --card:#111827; --accent:#2dd4bf;
      --text:#f3f4f6; --border:#1f2937;
      --pos:#10b981; --neg:#ef4444; --warn:#f59e0b;
      --muted:#9ca3af; --panel:#030712;
    }
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.5;}
    .container{max-width:1400px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:25px;align-items:start;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:25px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.5);}
    h1,h2,h3{color:var(--accent);margin-top:0;letter-spacing:-0.025em;}
    .formGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:20px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    label{font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;}
    input,select{background:var(--panel);border:1px solid var(--border);color:white;padding:10px;border-radius:8px;outline:none;transition:0.2s;}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(45,212,191,0.2);}
    .days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:15px;}
    .day-box{background:var(--panel);padding:12px;border-radius:10px;text-align:center;border:1px solid var(--border);}
    .day-box label{display:block;margin-bottom:5px;color:var(--accent);}
    .svc-card{border-left:4px solid var(--accent);background:#1f2937;padding:20px;border-radius:12px;margin-bottom:20px;position:relative;}
    .btn-del-svc{position:absolute;top:15px;right:15px;background:var(--neg);color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:10px;}
    .table-kit{width:100%;margin-top:15px;border-collapse:collapse;font-size:12px;}
    .table-kit th{text-align:left;color:var(--muted);padding:10px;border-bottom:1px solid var(--border);}
    .table-kit td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);}
    .table-kit input{width:90%;}
    .res-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--border);gap:12px;}
    .val{font-weight:700;font-family:'Courier New',monospace;font-size:16px;}
    .val-big{font-size:28px;display:block;margin-top:5px;font-weight:800;}
    .pos{color:var(--pos);} .neg{color:var(--neg);} .warn{color:var(--warn);}
    .btn{padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:700;border:none;transition:0.2s;}
    .btn-add{background:var(--accent);color:#070b14;}
    .btn-add:hover{background:#22d3ee;}
    .btn-ghost{background:#374151;color:white;}
    .btn-ghost:hover{filter:brightness(1.1);}
    .btn-small{padding:8px 12px;font-size:12px;border-radius:8px;}
    .chart-container{position:relative;height:250px;width:100%;margin:20px 0;}
    .table-compras{width:100%;border-collapse:collapse;font-size:12px;margin-top:15px;background:var(--panel);border-radius:10px;overflow:hidden;}
    .table-compras th{background:#1f2937;padding:12px;color:white;text-align:left;}
    .table-compras td{padding:10px;border-bottom:1px solid var(--border);}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(3,7,18,.6);font-size:12px;color:var(--muted);}
    .topbar{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;flex-wrap:wrap;margin-bottom:8px;}
    .subtle{font-size:12px;color:var(--muted);}
    .alert{border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.08);padding:10px 12px;border-radius:10px;color:#fde68a;font-size:12px;}
    .ok{border:1px solid rgba(16,185,129,.35);background:rgba(16,185,129,.08);padding:10px 12px;border-radius:10px;color:#d1fae5;font-size:12px;}
    .danger{border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.08);padding:10px 12px;border-radius:10px;color:#fecaca;font-size:12px;}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    @media (max-width:1100px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div>
      <h1>Potencial Business Pro <span style="font-weight:300;opacity:.6;">v4.6</span></h1>
      <div class="subtle">
        Objetivo: <b>Potencial de compra por FTE (G3)</b> + rentabilidad del salón + sell-in estimado por insumo.
      </div>
    </div>
    <div class="pill" id="modePill">Modo: Coaching + G3</div>
  </div>

  <div class="grid">
    <div class="inputs">
      <div class="card">
        <h2>0. Sesión (rápido y usable)</h2>
        <div class="formGrid">
          <div class="field"><label>Nombre del salón</label><input type="text" id="salonName" placeholder="Ej: Studio X"></div>
          <div class="field"><label>Zona / Ciudad</label><input type="text" id="salonZone" placeholder="Ej: Punta Carretas"></div>
          <div class="field"><label>Representante</label><input type="text" id="repName" placeholder="Ej: Sabrina"></div>
          <div class="field"><label>Ocupación (%)</label><input type="number" id="ocupacion" value="85" min="0" max="120" step="1"></div>
        </div>

        <div class="formGrid" style="margin-top:8px;">
          <div class="field">
            <label>Normalizar mix a 100%</label>
            <select id="mixPolicy">
              <option value="warn" selected>Advertir (no tocar)</option>
              <option value="normalize">Normalizar automático</option>
            </select>
          </div>
          <div class="field">
            <label>Comisión POS aplicada sobre</label>
            <select id="posBase">
              <option value="net" selected>Venta Neta</option>
              <option value="gross">Venta Bruta (con IVA)</option>
            </select>
          </div>
          <div class="field">
            <label>Política feriados</label>
            <select id="holidayPolicy">
              <option value="only_dates" selected>Descontar solo feriados listados</option>
              <option value="tourism_week">Descontar + Semana Turismo (Lun–Sáb)</option>
              <option value="none">No descontar feriados</option>
            </select>
          </div>
          <div class="field">
            <label>Acciones</label>
            <div class="row-actions">
              <button class="btn btn-ghost btn-small" onclick="exportCSV()">Exportar CSV (G3)</button>
              <button class="btn btn-ghost btn-small" onclick="copyJSON()">Copiar JSON (G3)</button>
              <button class="btn btn-ghost btn-small" onclick="resetAll()">Reset</button>
            </div>
          </div>
        </div>

        <div id="mixWarning" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <h2>1. Operación & Feriados Uruguay</h2>
        <div class="formGrid">
          <div class="field"><label>Año Fiscal</label><input type="number" id="year" value="2026"></div>
          <div class="field"><label>Semanas/Año</label><input type="number" id="weeks" value="48"></div>
          <div class="field"><label>Puestos</label><input type="number" id="puestos" value="2"></div>
          <div class="field"><label>Servicios/Puesto/Día</label><input type="number" id="servDia" value="3" step="0.1"></div>
          <div class="field"><label>Cotización USD</label><input type="number" id="tc" value="39.5" step="0.1"></div>
        </div>
        <div class="days-grid" id="daysRow"></div>
        <div id="feriadosAviso" style="font-size:11px;color:var(--muted);margin-top:10px;"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <h2>2. Servicios & Estructura de Kits</h2>
          <button class="btn btn-add" onclick="addServicio()">+ Agregar Servicio</button>
        </div>
        <div id="serviciosList"></div>
      </div>

      <div class="card">
        <h2>3. Gastos, RRHH e Impuestos</h2>
        <div class="formGrid">
          <div class="field"><label>Alquiler + Gastos (Mes)</label><input type="number" id="gFijos" value="35000"></div>
          <div class="field"><label>Sueldo FTE (Mes)</label><input type="number" id="sueldo" value="40000"></div>
          <div class="field"><label>Cant. FTEs (Estilistas)</label><input type="number" id="ftes" value="2"></div>
          <div class="field"><label>% Cargas Soc. (BPS)</label><input type="number" id="cargasSoc" value="45"></div>
          <div class="field"><label>IVA Ventas (%)</label><input type="number" id="iva" value="22"></div>
          <div class="field"><label>Comisión POS (%)</label><input type="number" id="comision" value="4"></div>
        </div>
      </div>
    </div>

    <div class="outputs">
      <div class="card" style="position:sticky;top:20px;border-top:5px solid var(--accent);">
        <h2>Resultados del Negocio</h2>
        <div id="resSummary"></div>

        <div class="chart-container"><canvas id="marginChart"></canvas></div>
        <div class="chart-container"><canvas id="distributionChart"></canvas></div>

        <hr style="border:0;border-top:1px solid var(--border);margin:25px 0;">

        <h3>G3 — Potencial de Compra por FTE</h3>
        <div id="resG3"></div>

        <hr style="border:0;border-top:1px solid var(--border);margin:25px 0;">

        <h3>Compras al Proveedor (Sell-In)</h3>
        <div id="resCompras"></div>

        <hr style="border:0;border-top:1px solid var(--border);margin:25px 0;">

        <h3>Equilibrio de Operación</h3>
        <div id="resBE"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   v4.6 — Estado + Utilidades
   Incluye: ocupación, mix policy, POS base, feriados, pérdida en chart,
            persistencia completa, IDs robustos, debounce, export CSV/JSON,
            y: servicios extra por FTE para llegar al BE.
   ========================= */

const LS_KEY = "pbp_v46_state";

const uid = () => {
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  return String(Date.now()) + "_" + String(Math.random()).slice(2);
};

const fmtUYU0 = (n) => (Number(n)||0).toLocaleString('es-UY', {maximumFractionDigits:0});
const clamp = (n, a, b) => Math.min(Math.max(n, a), b);

let mChart, dChart;

let state = loadState() || {
  salonName: "",
  salonZone: "",
  repName: "",
  ocupacion: 85,
  mixPolicy: "warn",
  posBase: "net",
  holidayPolicy: "only_dates",
  configDias: [0,1,1,1,1,1,1], // Dom-Sáb
  servicios: [{
    id: uid(), nombre: "Color Global", peso: 70, ticket: 2800,
    insumos: [
      { n: "Tinte 60g", p: 60, pr: 580, u: 30 },
      { n: "Oxidante 20vol 1L", p: 1000, pr: 1100, u: 60 }
    ]
  }, {
    id: uid(), nombre: "Balayage Premium", peso: 30, ticket: 4800,
    insumos: [
      { n: "Polvo Deco 500g", p: 500, pr: 1800, u: 120 },
      { n: "Oxidante 30vol 1L", p: 1000, pr: 1100, u: 200 }
    ]
  }],
  inputs: {
    year: 2026, weeks: 48, puestos: 2, servDia: 3, tc: 39.5,
    gFijos: 35000, sueldo: 40000, ftes: 2, cargasSoc: 45, iva: 22, comision: 4
  }
};

const diasNombres = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];

/* =========================
   Persistencia
   ========================= */
function saveState() {
  try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch(e){}
}
function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e){ return null; }
}
function resetAll() {
  localStorage.removeItem(LS_KEY);
  location.reload();
}

/* =========================
   UI Bind
   ========================= */
function hydrateInputs() {
  document.getElementById('salonName').value = state.salonName || "";
  document.getElementById('salonZone').value = state.salonZone || "";
  document.getElementById('repName').value = state.repName || "";
  document.getElementById('ocupacion').value = state.ocupacion ?? 85;
  document.getElementById('mixPolicy').value = state.mixPolicy || "warn";
  document.getElementById('posBase').value = state.posBase || "net";
  document.getElementById('holidayPolicy').value = state.holidayPolicy || "only_dates";

  const I = state.inputs || {};
  for (const k of Object.keys(I)) {
    const el = document.getElementById(k);
    if (el) el.value = I[k];
  }
}

function attachListeners() {
  const bind = (id, fn) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', fn);
    el.addEventListener('change', fn);
  };

  bind("salonName", () => { state.salonName = document.getElementById('salonName').value; saveState(); scheduleCalc(); });
  bind("salonZone", () => { state.salonZone = document.getElementById('salonZone').value; saveState(); scheduleCalc(); });
  bind("repName", () => { state.repName = document.getElementById('repName').value; saveState(); scheduleCalc(); });

  bind("ocupacion", () => {
    state.ocupacion = clamp(parseFloat(document.getElementById('ocupacion').value)||0, 0, 120);
    saveState(); scheduleCalc();
  });

  bind("mixPolicy", () => { state.mixPolicy = document.getElementById('mixPolicy').value; saveState(); scheduleCalc(); });
  bind("posBase", () => { state.posBase = document.getElementById('posBase').value; saveState(); scheduleCalc(); });
  bind("holidayPolicy", () => { state.holidayPolicy = document.getElementById('holidayPolicy').value; saveState(); scheduleCalc(); });

  const keys = ["year","weeks","puestos","servDia","tc","gFijos","sueldo","ftes","cargasSoc","iva","comision"];
  keys.forEach(k => bind(k, () => {
    const el = document.getElementById(k);
    state.inputs[k] = (el.type === "number") ? (parseFloat(el.value) || 0) : el.value;
    saveState();
    scheduleCalc();
  }));
}

/* =========================
   Render Servicios + Días
   ========================= */
function renderDays() {
  const dRow = document.getElementById('daysRow');
  dRow.innerHTML = diasNombres.map((name, i) => `
    <div class="day-box">
      <label>${name}</label>
      <select data-day="${i}">
        <option value="1" ${state.configDias[i]==1?'selected':''}>Full</option>
        <option value="0.5" ${state.configDias[i]==0.5?'selected':''}>1/2</option>
        <option value="0" ${state.configDias[i]==0?'selected':''}>OFF</option>
      </select>
    </div>
  `).join('');

  dRow.querySelectorAll('select[data-day]').forEach(sel => {
    sel.addEventListener('change', (e) => {
      const idx = parseInt(e.target.getAttribute('data-day'));
      state.configDias[idx] = parseFloat(e.target.value);
      saveState();
      scheduleCalc();
    });
  });
}

function renderServicios() {
  const sList = document.getElementById('serviciosList');
  sList.innerHTML = '';

  state.servicios.forEach((s) => {
    const costoKit = (s.insumos||[]).reduce((a, b) => a + (b.p > 0 ? b.pr * (b.u / b.p) : 0), 0);
    const div = document.createElement('div');
    div.className = 'svc-card';

    div.innerHTML = `
      <button class="btn-del-svc" onclick="removeServicio('${s.id}')">Eliminar Servicio</button>
      <div class="formGrid">
        <div class="field"><label>Nombre</label>
          <input type="text" value="${escapeAttr(s.nombre)}" oninput="updateS('${s.id}','nombre',this.value)">
        </div>
        <div class="field"><label>% Mix</label>
          <input type="number" value="${Number(s.peso)||0}" oninput="updateS('${s.id}','peso',this.value)">
        </div>
        <div class="field"><label>Ticket Bruto</label>
          <input type="number" value="${Number(s.ticket)||0}" oninput="updateS('${s.id}','ticket',this.value)">
        </div>
        <div class="field"><label>Costo Insumos</label>
          <span class="val" style="color:var(--accent);">UYU $ ${fmtUYU0(costoKit)}</span>
        </div>
      </div>

      <table class="table-kit">
        <thead><tr><th>Insumo Proveedor</th><th>Pack (g/ml)</th><th>$ Precio</th><th>Uso (g/ml)</th><th></th></tr></thead>
        <tbody>
          ${(s.insumos||[]).map((ins, idx) => `
            <tr>
              <td><input type="text" value="${escapeAttr(ins.n)}" oninput="updateI('${s.id}',${idx},'n',this.value)"></td>
              <td><input type="number" value="${Number(ins.p)||0}" oninput="updateI('${s.id}',${idx},'p',this.value)"></td>
              <td><input type="number" value="${Number(ins.pr)||0}" oninput="updateI('${s.id}',${idx},'pr',this.value)"></td>
              <td><input type="number" value="${Number(ins.u)||0}" oninput="updateI('${s.id}',${idx},'u',this.value)"></td>
              <td style="text-align:right"><button class="btn-del-svc" style="position:static;" onclick="removeI('${s.id}',${idx})">✕</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <button class="btn btn-add" style="font-size:10px;margin-top:10px;background:#374151;color:white;"
        onclick="addI('${s.id}')">+ Agregar Insumo</button>
    `;
    sList.appendChild(div);
  });
}

function escapeAttr(s) {
  return String(s ?? "").replaceAll("&","&amp;")
    .replaceAll("\"","&quot;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* =========================
   CRUD Servicios
   ========================= */
function addServicio() {
  state.servicios.push({ id: uid(), nombre: "Nuevo", peso: 0, ticket: 0, insumos: [] });
  saveState(); renderServicios(); scheduleCalc();
}
function removeServicio(id) {
  state.servicios = state.servicios.filter(x => x.id !== id);
  saveState(); renderServicios(); scheduleCalc();
}
function updateS(id, f, v) {
  const s = state.servicios.find(x => x.id === id);
  if (!s) return;
  s[f] = (f === 'nombre') ? v : (parseFloat(v) || 0);
  saveState(); scheduleCalc();
}
function addI(id) {
  const s = state.servicios.find(x => x.id === id);
  if (!s) return;
  s.insumos.push({ n: "Item", p: 1, pr: 0, u: 0 });
  saveState(); renderServicios(); scheduleCalc();
}
function removeI(sId, iIdx) {
  const s = state.servicios.find(x => x.id === sId);
  if (!s) return;
  s.insumos.splice(iIdx, 1);
  saveState(); renderServicios(); scheduleCalc();
}
function updateI(sId, iIdx, f, v) {
  const s = state.servicios.find(x => x.id === sId);
  if (!s || !s.insumos[iIdx]) return;
  s.insumos[iIdx][f] = (f === 'n') ? v : (parseFloat(v) || 0);
  saveState(); scheduleCalc();
}

/* =========================
   Feriados UY (práctico + móvil)
   ========================= */
function easterDate(year) {
  const a=year%19, b=Math.floor(year/100), c=year%100, d=Math.floor(b/4), e=b%4;
  const g=Math.floor((8*b+13)/25), h=(19*a+b-d-g+15)%30, i=Math.floor(c/4), k=c%4;
  const l=(32+2*e+2*i-h-k)%7, m=Math.floor((a+11*h+19*l)/433);
  const mon=Math.floor((h+l-7*m+90)/25), day=(h+l-7*m+33*mon+19)%32;
  return new Date(year, mon-1, day);
}
function addDays(date, n) {
  const r = new Date(date);
  r.setDate(r.getDate() + n);
  return r;
}
function getHolidaysUY(year, policy) {
  const easter = easterDate(year);

  const fixed = [
    {n:"Año Nuevo", d:new Date(year,0,1)},
    {n:"Reyes", d:new Date(year,0,6)},
    {n:"Desembarco 33", d:new Date(year,3,19)},
    {n:"Día de los Trabajadores", d:new Date(year,4,1)},
    {n:"Batalla Las Piedras", d:new Date(year,4,18)},
    {n:"Natalicio Artigas", d:new Date(year,5,19)},
    {n:"Juramento Constitución", d:new Date(year,6,18)},
    {n:"Independencia", d:new Date(year,7,25)},
    {n:"Día de la Raza", d:new Date(year,9,12)},
    {n:"Día de los Difuntos", d:new Date(year,10,2)},
    {n:"Navidad", d:new Date(year,11,25)}
  ];

  const mobile = [
    {n:"Lunes Carnaval", d:addDays(easter,-48)},
    {n:"Martes Carnaval", d:addDays(easter,-47)},
    {n:"Jueves (Turismo)", d:addDays(easter,-3)},
    {n:"Viernes (Turismo)", d:addDays(easter,-2)}
  ];

  let list = [...fixed, ...mobile];

  if (policy === "tourism_week") {
    // "Semana Turismo" práctica: Lun–Sáb de esa semana
    const mon = addDays(easter, -6);
    for (let i=0;i<6;i++) list.push({n:`Semana Turismo (día ${i+1})`, d:addDays(mon,i)});
  }

  return list;
}

/* =========================
   Cálculo (debounce + motor)
   ========================= */
let raf = null;
function scheduleCalc() {
  if (raf) cancelAnimationFrame(raf);
  raf = requestAnimationFrame(() => calculate());
}

function normalizeWeightsIfNeeded(servs) {
  const sum = servs.reduce((a,s)=>a+(Number(s.peso)||0),0);
  if (sum <= 0) return { sum, servs, normalized:false };
  if (Math.abs(sum - 100) < 0.001) return { sum, servs, normalized:false };

  if (state.mixPolicy === "normalize") {
    const factor = 100 / sum;
    const next = servs.map(s => ({...s, peso: (Number(s.peso)||0)*factor}));
    return { sum, servs: next, normalized:true };
  }
  return { sum, servs, normalized:false };
}

function calculate() {
  const yr = parseInt(state.inputs.year) || 2026;
  const wks = parseFloat(state.inputs.weeks) || 0;
  const psts = parseFloat(state.inputs.puestos) || 0;
  const sDia = parseFloat(state.inputs.servDia) || 0;
  const tc = parseFloat(state.inputs.tc) || 1;

  const iva = (parseFloat(state.inputs.iva) || 0) / 100;
  const com = (parseFloat(state.inputs.comision) || 0) / 100;

  const gF = parseFloat(state.inputs.gFijos) || 0;
  const su = parseFloat(state.inputs.sueldo) || 0;
  const fts = Math.max(1, parseFloat(state.inputs.ftes) || 1);
  const car = (parseFloat(state.inputs.cargasSoc) || 0) / 100;

  const ocup = clamp((parseFloat(state.ocupacion)||0)/100, 0, 1.2);

  const holPolicy = state.holidayPolicy || "only_dates";
  const holidays = (holPolicy === "none") ? [] : getHolidaysUY(yr, holPolicy);

  let offDays = 0;
  let feriadosAplicados = [];
  holidays.forEach(h => {
    const weight = state.configDias[h.d.getDay()] || 0;
    if (weight > 0) { offDays += weight; feriadosAplicados.push(h.n); }
  });

  const diasBase = (state.configDias.reduce((a,b)=>a+b,0) * wks);
  const diasAnio = Math.max(0, diasBase - offDays);

  const capServAnio = diasAnio * psts * sDia; // capacidad teórica
  const servAnio = capServAnio * ocup;        // capacidad usada (ocupación)

  document.getElementById('feriadosAviso').innerText =
    `Feriados que descuentan: ${feriadosAplicados.join(', ') || 'Ninguno'} · Días/año (base): ${diasBase.toFixed(1)} · Días/año (netos): ${diasAnio.toFixed(1)}`;

  const { sum:sumPeso, servs:servsForCalc } = normalizeWeightsIfNeeded(state.servicios);

  const mw = document.getElementById('mixWarning');
  if (state.servicios.length === 0) {
    mw.innerHTML = `<div class="danger">No hay servicios cargados. Agregá al menos 1 servicio para calcular.</div>`;
  } else if (sumPeso <= 0) {
    mw.innerHTML = `<div class="danger">El mix suma 0%. Asigná % Mix a los servicios.</div>`;
  } else if (Math.abs(sumPeso-100) > 0.01) {
    mw.innerHTML = `<div class="alert">
      El mix suma <b>${sumPeso.toFixed(1)}%</b>.
      ${state.mixPolicy==="normalize"
        ? `Se está <b>normalizando</b> automáticamente a 100% para el cálculo.`
        : `No se normaliza (se calcula tal cual).`}
    </div>`;
  } else {
    mw.innerHTML = `<div class="ok">Mix OK (100%).</div>`;
  }

  let factBruta = 0, factNeta = 0, costoInsumosTotal = 0;
  let invGlobal = {};
  let labelsS = [], dataContrib = [];

  let basePos = 0;

  servsForCalc.forEach(s => {
    const peso = Number(s.peso)||0;
    const cant = (capServAnio>0) ? (servAnio * (peso / 100)) : 0;

    const costoK = (s.insumos||[]).reduce((a,b)=>a + (b.p>0 ? (b.pr*(b.u/b.p)) : 0), 0);
    const tBruto = Number(s.ticket)||0;
    const tNeto = (1+iva)>0 ? tBruto/(1+iva) : tBruto;

    factBruta += cant * tBruto;
    factNeta  += cant * tNeto;
    costoInsumosTotal += cant * costoK;

    const posUnit = (state.posBase==="gross") ? (tBruto*com) : (tNeto*com);
    labelsS.push(s.nombre || "Servicio");
    dataContrib.push(tNeto - costoK - posUnit);

    basePos += (state.posBase==="gross") ? (cant*tBruto) : (cant*tNeto);

    (s.insumos||[]).forEach(i => {
      const name = i.n || "Item";
      if (!invGlobal[name]) invGlobal[name] = { u: 0, c: 0, pack: i.p || 0 };
      const totalUso = cant * (Number(i.u)||0);
      const unidades = (Number(i.p)||0) > 0 ? (totalUso / Number(i.p)) : 0;
      invGlobal[name].u += unidades;
      invGlobal[name].c += unidades * (Number(i.pr)||0);
    });
  });

  const comPos = basePos * com;
  const labAnual = (su * fts * 12) * (1 + car);
  const fijoAnual = gF * 12;
  const resAnual = factNeta - costoInsumosTotal - comPos - labAnual - fijoAnual;

  const color = resAnual >= 0 ? 'pos' : 'neg';

  document.getElementById('resSummary').innerHTML = `
    <div class="res-row"><span>Capacidad anual (teórica):</span><span class="val">${fmtUYU0(capServAnio)} serv</span></div>
    <div class="res-row"><span>Capacidad usada (ocupación ${Math.round(ocup*100)}%):</span><span class="val">${fmtUYU0(servAnio)} serv</span></div>
    <div class="res-row"><span>Venta neta anual:</span><span class="val">UYU $${fmtUYU0(factNeta)}</span></div>
    <div class="res-row"><span>Venta bruta anual:</span><span class="val">UYU $${fmtUYU0(factBruta)}</span></div>
    <div class="res-row"><span>Insumos (costo total):</span><span class="val neg">UYU $${fmtUYU0(costoInsumosTotal)}</span></div>
    <div class="res-row"><span>POS (${state.posBase==="gross" ? "sobre bruto" : "sobre neto"}):</span><span class="val neg">UYU $${fmtUYU0(comPos)}</span></div>
    <div class="res-row"><span>Fijos + Personal (anual):</span><span class="val neg">UYU $${fmtUYU0(fijoAnual + labAnual)}</span></div>
    <div class="res-row" style="margin-top:15px;border:none;color:var(--accent);"><b>EXCEDENTE NETO ANUAL:</b></div>
    <span class="val-big ${color}">UYU $${fmtUYU0(resAnual)}</span>
    <span class="val-big ${color}" style="font-size:18px;opacity:.8;">USD $${fmtUYU0(resAnual/tc)}</span>
  `;

  // G3 — Potencial compra por FTE
  const compraTotalUYU = costoInsumosTotal;
  const compraFTE_UYU = compraTotalUYU / fts;
  const compraFTE_USD = compraFTE_UYU / tc;
  const compraFTE_Mes_UYU = compraFTE_UYU / 12;
  const compraFTE_Mes_USD = compraFTE_USD / 12;

  let g3Badge = "ok";
  let g3Msg = "Potencial calculado";
  if (servAnio <= 0 || compraTotalUYU <= 0) { g3Badge="danger"; g3Msg="Faltan datos o ocupación muy baja"; }
  else if (resAnual < 0) { g3Badge="alert"; g3Msg="Compra potencial existe, pero el negocio no cierra (pérdida)"; }

  const badgeHtml = (g3Badge==="ok")
    ? `<div class="ok">${g3Msg}</div>`
    : (g3Badge==="alert")
      ? `<div class="alert">${g3Msg}</div>`
      : `<div class="danger">${g3Msg}</div>`;

  document.getElementById('resG3').innerHTML = `
    ${badgeHtml}
    <div class="res-row"><span><b>Compra anual estimada</b> (G3):</span><span class="val">UYU $${fmtUYU0(compraTotalUYU)}</span></div>
    <div class="res-row"><span><b>Compra anual por FTE</b> (G3):</span><span class="val">UYU $${fmtUYU0(compraFTE_UYU)}</span></div>
    <div class="res-row"><span>Compra anual por FTE (USD):</span><span class="val">USD $${fmtUYU0(compraFTE_USD)}</span></div>
    <div class="res-row"><span>Compra mensual por FTE:</span><span class="val">UYU $${fmtUYU0(compraFTE_Mes_UYU)} (USD $${fmtUYU0(compraFTE_Mes_USD)})</span></div>
  `;

  // Sell-in tabla
  const rowsInv = Object.keys(invGlobal)
    .sort((a,b)=>invGlobal[b].c - invGlobal[a].c)
    .map(k => `
      <tr>
        <td>${escapeAttr(k)}</td>
        <td>${Math.ceil(invGlobal[k].u)} und</td>
        <td>UYU $${fmtUYU0(invGlobal[k].c)}</td>
      </tr>
    `).join('');

  document.getElementById('resCompras').innerHTML = `
    <div class="res-row"><span>Compra anual por Estilista (FTE):</span><span class="val">UYU $${fmtUYU0(compraFTE_UYU)}</span></div>
    <div class="res-row"><span>Compra anual por Estilista (USD):</span><span class="val">USD $${fmtUYU0(compraFTE_USD)}</span></div>
    <table class="table-compras">
      <thead><tr><th>Producto Proveedor</th><th>Unidades Anuales</th><th>Inversión Total</th></tr></thead>
      <tbody>${rowsInv || `<tr><td colspan="3" style="padding:12px;color:var(--muted);">Sin insumos cargados</td></tr>`}</tbody>
    </table>
  `;

  // Break-even + NUEVO: servicios extra por FTE
  const mUnit = (servAnio > 0) ? (factNeta - costoInsumosTotal - comPos) / servAnio : 0; // contribución promedio por servicio
  const beMesTotal = (mUnit > 0) ? (gF + (su * fts * (1+car))) / mUnit : 0; // servicios/mes del salón para BE

  const servMesActualTotal = servAnio / 12;
  const servMesActualPorFTE = servMesActualTotal / fts;

  const beMesPorFTE = (mUnit > 0) ? (beMesTotal / fts) : 0;

  const diasMes = diasAnio / 12;
  const extraServMesPorFTE = (mUnit > 0) ? Math.max(0, beMesPorFTE - servMesActualPorFTE) : 0;
  const extraServDiaPorFTE = (diasMes > 0) ? (extraServMesPorFTE / diasMes) : 0;

  document.getElementById('resBE').innerHTML = `
    <div class="res-row"><span>Punto de equilibrio (salón):</span><span class="val ${mUnit>0?'pos':'neg'}">${mUnit>0 ? Math.ceil(beMesTotal) : '—'} serv/mes</span></div>
    <div class="res-row"><span>Actual (salón):</span><span class="val">${fmtUYU0(servMesActualTotal)} serv/mes</span></div>

    <div class="res-row"><span>Punto de equilibrio (por FTE):</span><span class="val ${mUnit>0?'pos':'neg'}">${mUnit>0 ? Math.ceil(beMesPorFTE) : '—'} serv/mes/FTE</span></div>
    <div class="res-row"><span>Actual (por FTE):</span><span class="val">${fmtUYU0(servMesActualPorFTE)} serv/mes/FTE</span></div>

    <div class="res-row"><span><b>Faltan</b> (por FTE) para BE:</span>
      <span class="val ${extraServMesPorFTE>0 ? 'warn' : 'pos'}">
        ${mUnit>0 ? `${extraServMesPorFTE.toFixed(1)} serv/mes/FTE` : '—'}
      </span>
    </div>
    <div class="res-row" style="border-bottom:none;"><span>Eso es aprox (por día/FTE):</span>
      <span class="val ${extraServDiaPorFTE>0 ? 'warn' : 'pos'}">
        ${mUnit>0 ? `${extraServDiaPorFTE.toFixed(2)} serv/día/FTE` : '—'}
      </span>
    </div>

    ${servsForCalc.map(s => `
      <div class="res-row" style="font-size:11px;border:none;">
        <span>${escapeAttr(s.nombre)} (${(Number(s.peso)||0).toFixed(1)}%):</span>
        <span>${mUnit>0 ? Math.ceil(beMesTotal * (Number(s.peso)||0) / 100) : '—'} serv</span>
      </div>
    `).join('')}
  `;

  updateCharts(labelsS, dataContrib, costoInsumosTotal, comPos, fijoAnual, labAnual, resAnual);

  saveState();
  document.getElementById('modePill').innerText =
    `Modo: Coaching + G3 · Compra/FTE (UYU/año): ${fmtUYU0(compraFTE_UYU)}`;
}

function updateCharts(labels, contrib, ins, com, fij, lab, res) {
  const ctx1 = document.getElementById('marginChart').getContext('2d');
  if (mChart) mChart.destroy();
  mChart = new Chart(ctx1, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Contribución por servicio (UYU)', data: contrib, backgroundColor: '#2dd4bf' }]},
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false }},
      scales:{
        y:{ grid:{ color:'#374151' }, ticks:{ color:'#9ca3af' } },
        x:{ ticks:{ color:'#9ca3af' } }
      }
    }
  });

  const ctx2 = document.getElementById('distributionChart').getContext('2d');
  if (dChart) dChart.destroy();

  const labelsD = ['Insumos','POS','Local','Personal'];
  const dataD = [ins, com, fij, lab];

  if (res >= 0) { labelsD.push('Beneficio'); dataD.push(res); }
  else { labelsD.push('Pérdida'); dataD.push(Math.abs(res)); }

  dChart = new Chart(ctx2, {
    type:'doughnut',
    data:{ labels:labelsD, datasets:[{
      data:dataD,
      backgroundColor:['#f87171','#fb923c','#fbbf24','#818cf8', res>=0 ? '#34d399' : '#ef4444'],
      borderWidth:0
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:'right', labels:{ color:'#f3f4f6', font:{ size:10 } } } }
    }
  });
}

/* =========================
   Export G3 (CSV + JSON)
   ========================= */
function buildG3Payload() {
  const yr = parseInt(state.inputs.year) || 2026;
  const wks = parseFloat(state.inputs.weeks) || 0;
  const psts = parseFloat(state.inputs.puestos) || 0;
  const sDia = parseFloat(state.inputs.servDia) || 0;
  const tc = parseFloat(state.inputs.tc) || 1;

  const iva = (parseFloat(state.inputs.iva) || 0) / 100;
  const com = (parseFloat(state.inputs.comision) || 0) / 100;

  const gF = parseFloat(state.inputs.gFijos) || 0;
  const su = parseFloat(state.inputs.sueldo) || 0;
  const fts = Math.max(1, parseFloat(state.inputs.ftes) || 1);
  const car = (parseFloat(state.inputs.cargasSoc) || 0) / 100;

  const ocup = clamp((parseFloat(state.ocupacion)||0)/100, 0, 1.2);

  const holPolicy = state.holidayPolicy || "only_dates";
  const holidays = (holPolicy === "none") ? [] : getHolidaysUY(yr, holPolicy);

  let offDays = 0;
  holidays.forEach(h => {
    const weight = state.configDias[h.d.getDay()] || 0;
    if (weight > 0) offDays += weight;
  });

  const diasBase = (state.configDias.reduce((a,b)=>a+b,0) * wks);
  const diasAnio = Math.max(0, diasBase - offDays);
  const capServAnio = diasAnio * psts * sDia;
  const servAnio = capServAnio * ocup;

  const { servs:servsForCalc } = normalizeWeightsIfNeeded(state.servicios);

  let factBruta=0, factNeta=0, costoInsumosTotal=0;
  let basePos=0;

  servsForCalc.forEach(s=>{
    const cant = capServAnio>0 ? (servAnio*((Number(s.peso)||0)/100)) : 0;
    const costoK = (s.insumos||[]).reduce((a,b)=>a + (b.p>0 ? (b.pr*(b.u/b.p)) : 0), 0);
    const tBruto = Number(s.ticket)||0;
    const tNeto = (1+iva)>0 ? tBruto/(1+iva) : tBruto;

    factBruta += cant*tBruto;
    factNeta  += cant*tNeto;
    costoInsumosTotal += cant*costoK;

    basePos += (state.posBase==="gross") ? (cant*tBruto) : (cant*tNeto);
  });

  const comPos = basePos*com;
  const labAnual = (su * fts * 12) * (1 + car);
  const fijoAnual = gF * 12;
  const resAnual = factNeta - costoInsumosTotal - comPos - labAnual - fijoAnual;

  const compraTotalUYU = costoInsumosTotal;
  const compraFTE_UYU = compraTotalUYU / fts;

  return {
    meta: {
      version: "4.6",
      timestamp: new Date().toISOString(),
      salonName: state.salonName || "",
      salonZone: state.salonZone || "",
      repName: state.repName || ""
    },
    inputs: {
      year: yr,
      weeks: wks,
      puestos: psts,
      servPorPuestoDia: sDia,
      ocupacionPct: Math.round(ocup*100),
      tcUSD: tc,
      ivaPct: Math.round(iva*100),
      comisionPct: Math.round(com*100),
      gFijosMes: gF,
      sueldoFTE_Mes: su,
      ftes: fts,
      cargasSocPct: Math.round(car*100),
      posBase: state.posBase,
      holidayPolicy: state.holidayPolicy,
      configDias: state.configDias
    },
    kpis: {
      capacidadServiciosAnio: capServAnio,
      serviciosEstimadosAnio: servAnio,
      ventaNetaAnualUYU: factNeta,
      ventaBrutaAnualUYU: factBruta,
      costoInsumosAnualUYU: costoInsumosTotal,
      compraAnualUYU: compraTotalUYU,
      compraAnualPorFTE_UYU: compraFTE_UYU,
      compraAnualPorFTE_USD: compraFTE_UYU / tc,
      excedenteAnualUYU: resAnual,
      excedenteAnualUSD: resAnual / tc
    },
    servicios: state.servicios
  };
}

function copyJSON() {
  const payload = buildG3Payload();
  const txt = JSON.stringify(payload, null, 2);
  navigator.clipboard.writeText(txt).then(() => {
    flashPill("JSON copiado ✓");
  }).catch(() => {
    alert("No se pudo copiar. (Permisos del navegador)");
  });
}

function exportCSV() {
  const p = buildG3Payload();
  const row = {
    timestamp: p.meta.timestamp,
    salonName: p.meta.salonName,
    salonZone: p.meta.salonZone,
    repName: p.meta.repName,
    year: p.inputs.year,
    weeks: p.inputs.weeks,
    puestos: p.inputs.puestos,
    servPorPuestoDia: p.inputs.servPorPuestoDia,
    ocupacionPct: p.inputs.ocupacionPct,
    ftes: p.inputs.ftes,
    ventaNetaAnualUYU: p.kpis.ventaNetaAnualUYU,
    compraAnualUYU: p.kpis.compraAnualUYU,
    compraAnualPorFTE_UYU: p.kpis.compraAnualPorFTE_UYU,
    compraAnualPorFTE_USD: p.kpis.compraAnualPorFTE_USD,
    excedenteAnualUYU: p.kpis.excedenteAnualUYU,
    posBase: p.inputs.posBase,
    holidayPolicy: p.inputs.holidayPolicy
  };

  const headers = Object.keys(row);
  const csv = [
    headers.join(","),
    headers.map(h => csvEscape(row[h])).join(",")
  ].join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `G3_Potencial_${(p.meta.salonName||"salon").replaceAll(" ","_")}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  flashPill("CSV descargado ✓");
}

function csvEscape(v) {
  const s = String(v ?? "");
  if (s.includes(",") || s.includes("\"") || s.includes("\n")) {
    return "\"" + s.replaceAll("\"","\"\"") + "\"";
  }
  return s;
}

let pillTimer = null;
function flashPill(msg) {
  const el = document.getElementById('modePill');
  const prev = el.innerText;
  el.innerText = msg;
  if (pillTimer) clearTimeout(pillTimer);
  pillTimer = setTimeout(()=>{ el.innerText = prev; }, 1200);
}

/* =========================
   Init
   ========================= */
function renderAll() {
  hydrateInputs();
  renderDays();
  renderServicios();
}
renderAll();
attachListeners();
scheduleCalc();
</script>
</body>
</html>

